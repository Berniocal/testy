<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Online test z Excelu – učitel</title>
  <meta name="theme-color" content="#0b1323">
  <style>
    :root{
      --bg:#0b1323; --bg2:#0f1722; --panel:#101826;
      --text:#e6eef8; --muted:#9fb0c7; --accent:#60a5fa;
      --ok:#22c55e; --warn:#f97316; --err:#ef4444;
      --r:14px; --gap:12px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0;
      min-height:100%;
      background:linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:min(1100px,96vw);margin:20px auto;padding:10px}
    h1,h2,h3{margin:0 0 10px}
    .panel{
      background:var(--panel);
      border-radius:var(--r);
      padding:16px;
      box-shadow:0 14px 40px rgba(0,0,0,.4);
      margin-bottom:16px;
    }
    label{display:block;margin:6px 0;}
    input[type="number"], input[type="text"], input[type="datetime-local"]{
      width:100%;
      max-width:260px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#0b1220;
      color:var(--text);
    }
    input[type="checkbox"]{margin-right:6px}
    button{
      border:0;
      padding:8px 14px;
      border-radius:999px;
      background:var(--accent);
      color:#0b1020;
      font-weight:600;
      cursor:pointer;
      margin:4px 4px 0 0;
    }
    button[disabled]{opacity:.55;cursor:not-allowed}
    .btn-secondary{
      background:#020617;color:var(--text);
      border:1px solid #1f2937;
    }
    .muted{color:var(--muted);font-size:.9rem}
    .row{display:flex;flex-wrap:wrap;gap:var(--gap);}
    .row > div{flex:1 1 260px}
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:26px;height:26px;
      padding:0 8px;
      border-radius:999px;
      font-size:.9rem;
      border:1px solid #1f2937;
      background:#020617;
      margin:2px;
      cursor:pointer;
      user-select:none;
    }
    .badge.answered{background:#022c22;border-color:#16a34a;color:#bbf7d0}
    .badge.current{outline:2px solid var(--accent);}
    .badge:hover{background:#02091a}
    .q-text{font-size:1.05rem;margin-bottom:8px}
    .answers label{
      display:flex;align-items:flex-start;
      gap:8px;
      padding:6px 8px;
      border-radius:10px;
      background:#020617;
      margin-bottom:4px;
      cursor:pointer;
    }
    .answers input{margin-top:3px}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;gap:8px;
    }
    .timer{
      padding:4px 10px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1f2937;
      font-weight:600;
    }
    .timer.expiring{background:#3b0764;border-color:#a855f7}
    .timer.over{background:#3b0a0a;border-color:#b91c1c}
    .nav-row{
      display:flex;flex-wrap:wrap;gap:4px;
      margin-bottom:8px;
    }
    .btn-row{
      display:flex;justify-content:space-between;
      margin-top:12px;gap:8px;
    }
    pre{
      background:#020617;
      padding:8px 10px;
      border-radius:8px;
      font-size:.8rem;
      overflow:auto;
      max-height:240px;
    }
    @media (max-width:600px){
      .btn-row{flex-direction:column;}
      .btn-row button{width:100%}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Online test z Excelu – učitelská verze</h1>

  <div class="panel" id="teacher-panel">
    <h2>1) Nastavení testu (učitel)</h2>
    <div class="row">
      <div>
        <label>
          Soubor Excel (.xlsx) s otázkami:
          <input type="file" id="file-input" accept=".xlsx">
        </label>
        <div class="muted">
          Sloupec A = otázka, B–G = odpovědi. Správné odpovědi označ hvězdičkou <code>*</code> na konci textu.
        </div>
        <label style="margin-top:8px;">
          ID testu (krátký kód, např. <i>9A-elektro-1</i>):
          <input type="text" id="test-id" placeholder="např. 9A-elektro-1">
        </label>
        <div class="muted">Tento kód se uloží k výsledkům v Google tabulce.</div>
      </div>
      <div>
        <strong>Volby:</strong>
        <label><input type="checkbox" id="shuffle-questions" checked> Míchat pořadí otázek</label>
        <label><input type="checkbox" id="shuffle-answers" checked> Míchat pořadí odpovědí</label>
      </div>
      <div>
        <strong>Časování:</strong>
        <label>
          <input type="radio" name="time-mode" value="limit" id="mode-limit" checked>
          Časový limit na test (minuty):
        </label>
        <input type="number" id="time-limit" min="1" max="300" value="20">

        <label style="margin-top:8px;">
          <input type="radio" name="time-mode" value="window" id="mode-window">
          Časové okno (od – do):
        </label>
        <label>Začátek:
          <input type="datetime-local" id="start-at">
        </label>
        <label>Konec:
          <input type="datetime-local" id="end-at">
        </label>
        <div class="muted">
          V tomto prototypu se okno kontroluje podle času zařízení žáka.
        </div>
      </div>
    </div>
    <button id="btn-preview" disabled>Náhled otázek</button>
    <button id="btn-start-local" disabled>Spustit test jen zde (náhled)</button>
    <button id="btn-generate-link" disabled>Vygenerovat odkaz pro žáky</button>
    <div id="teacher-info" class="muted" style="margin-top:8px;"></div>
    <div id="link-output" class="muted" style="margin-top:8px;"></div>
    <div id="qr-container" style="margin-top:8px;"></div>
    <div id="preview" style="margin-top:10px;"></div>
  </div>

  <!-- náhled pro učitele, necháme jak máš -->
  <div class="panel" id="student-panel" style="display:none;">
    <!-- ... tvoje náhledová část, tu neměním ... -->
    Náhled (pro učitele) – ten teď neřešíme do detailu.
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycby_nyIz2pYtHD3h00eOW9cxi25DuEEe4jAN3a2MHj-2Y-fmGoffC_SE_zYj4VDNUC-x/exec";

  let loadedQuestions = [];

  const fileInput  = document.getElementById('file-input');
  const btnPreview = document.getElementById('btn-preview');
  const btnStartLocal = document.getElementById('btn-start-local');
  const btnGenLink = document.getElementById('btn-generate-link');
  const teacherInfo= document.getElementById('teacher-info');
  const previewDiv = document.getElementById('preview');
  const linkOutput = document.getElementById('link-output');

  fileInput.addEventListener('change', handleFileSelect);

  function handleFileSelect(evt){
    const file = evt.target.files[0];
    loadedQuestions = [];
    btnPreview.disabled = true;
    btnStartLocal.disabled = true;
    btnGenLink.disabled = true;
    previewDiv.innerHTML = "";
    linkOutput.textContent = "";
    teacherInfo.textContent = "";

    if(!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      try{
        const data = e.target.result;
        const workbook = XLSX.read(data, {type:'array'});
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1});

        for(let i=1;i<rows.length;i++){
          const row = rows[i];
          if(!row || !row[0]) continue;
          const qText = String(row[0]).trim();
          const answers = [];
          for(let col=1; col<=6; col++){
            const cell = row[col];
            if(cell == null || cell === "") continue;
            let txt = String(cell).trim();
            let isCorrect = false;
            if(/\*+$/.test(txt)){
              isCorrect = true;
              txt = txt.replace(/\*+$/,"").trim();
            }
            answers.push({text: txt, isCorrect:isCorrect});
          }
          if(answers.length >= 2){
            const id = "Q" + i;
            loadedQuestions.push({id, text:qText, answers});
          }
        }

        if(loadedQuestions.length === 0){
          teacherInfo.textContent = "V souboru se nenašly žádné platné otázky.";
          return;
        }
        teacherInfo.textContent = `Načteno otázek: ${loadedQuestions.length}.`;
        btnPreview.disabled = false;
        btnStartLocal.disabled = false;
        btnGenLink.disabled = false;
      }catch(err){
        console.error(err);
        teacherInfo.textContent = "Chyba při čtení Excelu. Zkontroluj formát.";
      }
    };
    reader.readAsArrayBuffer(file);
  }

  btnPreview.addEventListener('click', ()=>{
    if(!loadedQuestions.length) return;
    const maxPreview = Math.min(5, loadedQuestions.length);
    let html = `<h3>Náhled prvních ${maxPreview} otázek</h3><ol>`;
    for(let i=0;i<maxPreview;i++){
      const q = loadedQuestions[i];
      html += `<li>${escapeHtml(q.text)}<ul>`;
      q.answers.forEach(a=>{
        html += `<li>${escapeHtml(a.text)} ${a.isCorrect ? "<strong>(správně)</strong>" : ""}</li>`;
      });
      html += "</ul></li>";
    }
    html += "</ol>";
    previewDiv.innerHTML = html;
  });

  // jen utilita, kdybys chtěl později lokálně spouštět náhled (teď neřešíme)
  btnStartLocal.addEventListener('click', ()=>{
    alert("Lokální náhled teď neřešíme, důležitý je odkaz a QR pro žáky.");
  });

  // === GENEROVÁNÍ ODKAZU A QR KÓDU – ULOŽENÍ TESTU NA SERVER ===
btnGenLink.addEventListener('click', ()=>{
  if(!loadedQuestions.length){
    alert("Nejdřív nahraj Excel.");
    return;
  }

  const shuffleQuestionsFlag = document.getElementById('shuffle-questions').checked;
  const shuffleAnswersFlag   = document.getElementById('shuffle-answers').checked;
  const modeLimit  = document.getElementById('mode-limit').checked;
  const modeWindow = document.getElementById('mode-window').checked;
  const timeLimitMin = parseInt(document.getElementById('time-limit').value,10) || 0;
  const startAtStr = document.getElementById('start-at').value;
  const endAtStr   = document.getElementById('end-at').value;
  const testIdInput = document.getElementById('test-id');
  const testId = testIdInput && testIdInput.value.trim()
    ? testIdInput.value.trim()
    : "TEST-" + Date.now();

  // objekt testu, který se uloží do Google Sheets -> Testy
  const testObj = {
    testId,
    questions: loadedQuestions,   // nezamíchané, shuffle až u žáka
    shuffleQuestions: shuffleQuestionsFlag,
    shuffleAnswers:   shuffleAnswersFlag,
    timeMode: modeLimit ? "limit" : (modeWindow ? "window" : null),
    timeLimitSec: modeLimit && timeLimitMin>0 ? timeLimitMin*60 : null,
    startAt: modeWindow && startAtStr ? new Date(startAtStr).toISOString() : null,
    endAt:   modeWindow && endAtStr   ? new Date(endAtStr).toISOString()   : null
  };

  // pošli test na Apps Script (eventType = saveTest)
  try{
    fetch(API_URL, {
      method: "POST",
      mode: "no-cors",          // CORS neřešíme, jen posíláme
      body: JSON.stringify({
        eventType: "saveTest",
        testId: testId,
        test: testObj
      })
    });
  }catch(err){
    console.error("Chyba při odesílání testu na server:", err);
  }

  const studentUrl = `student-test.html#${encodeURIComponent(testId)}`;

  linkOutput.innerHTML = `
    <strong>Odkaz pro žáky:</strong><br>
    <a href="${studentUrl}" target="_blank">${studentUrl}</a>
  `;

  const qrDiv = document.getElementById('qr-container');
  qrDiv.innerHTML = `
    <div class="muted" style="margin-top:6px;">QR kód pro žáky:</div>
    <img src="https://chart.googleapis.com/chart?cht=qr&chs=240x240&chl=${encodeURIComponent(studentUrl)}"
         alt="QR kód testu">
  `;
  // --- uložit definici testu na server (Apps Script) ---
  if (API_URL) {
    const body = {
      eventType: 'saveTest',
      testId: testId,
      // tady dáme stejný objekt, jaký jsme před chvílí použili pro studenty
      test: payload
    };

    try {
      fetch(API_URL, {
        method: "POST",
        mode: "no-cors",                 // odpověď nás nezajímá, jen aby to došlo
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      }).catch(err => {
        console.error("Chyba při ukládání testu na server:", err);
      });
    } catch (e) {
      console.error("Výjimka při ukládání testu:", e);
    }
  }

  teacherInfo.textContent = "Test byl odeslán na server (uložen pod ID: " + testId + ").";
});


  function escapeHtml(str){
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }
</script>
</body>
</html>
