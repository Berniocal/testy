<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title id="doc-title">Online test</title>
  <meta name="theme-color" content="#0b1323">
  <style>
    :root{
      --bg:#0b1323; --bg2:#0f1722; --panel:#101826;
      --text:#e6eef8; --muted:#9fb0c7; --accent:#60a5fa;
      --ok:#22c55e; --warn:#f97316; --err:#ef4444;
      --r:14px; --gap:12px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0;
      min-height:100%;
      background:linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{
      max-width:min(900px,96vw);
      margin:20px auto;
      padding:10px;
    }
    h1,h2,h3{margin:0 0 10px}
    .panel{
      background:var(--panel);
      border-radius:var(--r);
      padding:16px;
      box-shadow:0 14px 40px rgba(0,0,0,.4);
      margin-bottom:16px;
    }
    .muted{color:var(--muted);font-size:.9rem}
    label{display:block;margin:6px 0;}
    input[type="text"]{
      width:100%;
      max-width:260px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#0b1220;
      color:var(--text);
    }
    button{
      border:0;
      padding:8px 14px;
      border-radius:999px;
      background:var(--accent);
      color:#0b1020;
      font-weight:600;
      cursor:pointer;
      margin:6px 6px 0 0;
    }
    button[disabled]{opacity:.55;cursor:not-allowed}
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .timer{
      min-width:80px;
      padding:6px 10px;
      border-radius:999px;
      background:#020617;
      text-align:center;
      font-variant-numeric:tabular-nums;
    }
    .timer.expiring{background:#451a03;color:#fed7aa;}
    .timer.over{background:#450a0a;color:#fecaca;}
    .nav-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:10px;
    }
    .badge{
      min-width:26px;
      padding:0 8px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:#020617;
      text-align:center;
      font-size:.8rem;
      cursor:pointer;
    }
    .badge.current{background:var(--accent);color:#020617;}
    .badge.answered{border-color:var(--ok);color:var(--ok);}
    .answers label{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:8px;
      background:#020617;
      margin-bottom:4px;
      cursor:pointer;
    }
    .answers input[type="checkbox"]{margin:0;}
    .btn-row{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-top:10px;
      flex-wrap:nowrap;          /* tlačítka v jednom řádku */
    }
    .btn-row button{
      flex:0 0 auto;             /* už se neroztahují přes celou šířku */
      padding:8px 16px;
      min-width:120px;
    }
    @media (max-width:600px){
      .topbar{flex-direction:column;align-items:flex-start;}
      /* tlačítka necháváme vodorovně i na mobilu */
    }

    video#keep-awake{
      width:0;height:0;opacity:0;position:absolute;pointer-events:none;
    }
  </style>

  <!-- MathJax konfigurace + skript -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [
          ['\\(','\\)'],
          ['$', '$']
        ]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script"
          async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
  </script>
</head>
<body>
<div class="wrap">
  <h1 id="page-title">Online test</h1>

  <div class="panel" id="loading-panel">
    Načítám test…
  </div>

  <div class="panel" id="error-panel" style="display:none;">
    <h2>Chyba</h2>
    <div id="error-text"></div>
  </div>

  <div class="panel" id="student-panel" style="display:none;">
    <div id="student-start">
      <h2>Test – přihlášení</h2>
      <div class="muted" id="test-info"></div>
      <label style="margin-top:8px;">
        Jméno nebo kód žáka:
        <input type="text" id="student-name" placeholder="Např. Novák Jan nebo 2.A-05">
      </label>
      <div class="muted">Jméno se použije jen pro vyhodnocení (stejně jako u papírového testu).</div>
      <button id="btn-start-test">Začít test</button>
      <div id="start-error" class="muted" style="color:#ef4444;margin-top:6px;"></div>
    </div>

    <div id="student-test" style="display:none;">
      <div class="topbar">
        <div>
          <strong id="test-title">Test</strong><br>
          <span class="muted" id="test-subtitle"></span>
        </div>
        <div id="timer" class="timer" style="display:none;">--:--</div>
      </div>

      <div class="nav-row" id="question-nav"></div>

      <h3 id="question-text"></h3>
      <div class="answers" id="answers"></div>

<div class="btn-row">
  <button id="btn-prev">Předchozí</button>
  <button id="btn-next">Další otázka</button>
</div>
<button id="btn-finish" class="btn-secondary" style="display:none;margin-top:8px;">
  Ukončit test
</button>


      <div id="test-hint" class="muted" style="margin-top:8px;"></div>
    </div>

    <div id="student-result" style="display:none;">
      <h2>Výsledek testu</h2>
      <p id="result-summary"></p>
      <pre id="result-json" style="display:none;"></pre>
      <div class="muted">
        Počkej prosím, než učitel potvrdí, že se výsledek uložil.
      </div>
    </div>
  </div>

  <!-- neviditelné video kvůli udržení „probuzené“ obrazovky -->
  <video id="keep-awake" loop muted playsinline>
    <source src="data:video/mp4;base64,AAAA" type="video/mp4">
  </video>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbx0KKR5tBAxu4OjVpgeKT3XjEXBz7J9IybVpyUyqP8_QNY35NTLWBK2puVU6b9jm2we/exec";

  const loadingPanel = document.getElementById('loading-panel');
  const errorPanel   = document.getElementById('error-panel');
  const errorText    = document.getElementById('error-text');
  const studentPanel = document.getElementById('student-panel');

  const studentStartDiv  = document.getElementById('student-start');
  const studentTestDiv   = document.getElementById('student-test');
  const studentResultDiv = document.getElementById('student-result');

  const testInfo     = document.getElementById('test-info');
  const questionNav  = document.getElementById('question-nav');
  const questionText = document.getElementById('question-text');
  const answersEl    = document.getElementById('answers');
  const timerEl      = document.getElementById('timer');
  const testHint     = document.getElementById('test-hint');

  const btnStartTest = document.getElementById('btn-start-test');
  const startError   = document.getElementById('start-error');
  const btnPrev      = document.getElementById('btn-prev');
  const btnNext      = document.getElementById('btn-next');
  const btnFinish    = document.getElementById('btn-finish');

  const resultSummary = document.getElementById('result-summary');
  const resultJson    = document.getElementById('result-json');

  const pageTitleEl = document.getElementById('page-title');
  const keepAwakeVideo = document.getElementById('keep-awake');

  let testConfig = null;
  let testState = {
    studentName: "",
    startedAt: null,
    finishedAt: null,
    finished: false,
    currentIndex: 0,
    answers: {},            // {questionId: [indexy odpovědí]}
    remainingSeconds: 0,
    timerInterval: null
  };

  // =====================================================================
  // Načtení testu z Apps Scriptu (JSONP)
  // =====================================================================
  const hash = window.location.hash ? window.location.hash.substring(1) : "";
  const testId = decodeURIComponent(hash || "").trim();

  if(!testId){
    loadingPanel.style.display = "none";
    errorPanel.style.display   = "block";
    errorText.textContent = "V URL chybí ID testu (#TESTID). Požádej učitele o správný odkaz.";
  }else{
    loadTestFromServer(testId);
  }

  function loadTestFromServer(testId){
    const cbName = "handleTest_" + Date.now();
    window[cbName] = function(resp){
      try{
        if(!resp || resp.status !== "ok" || !resp.test){
          throw new Error(resp && resp.message ? resp.message : "Test nenalezen");
        }
        initTest(resp.test, testId);
      }catch(err){
        console.error(err);
        loadingPanel.style.display = "none";
        errorPanel.style.display   = "block";
        errorText.textContent = "Nepodařilo se načíst test: " + err.message;
      }finally{
        delete window[cbName];
      }
    };

    const s = document.createElement("script");
    const url = API_URL
      + "?mode=getTest"
      + "&testId=" + encodeURIComponent(testId)
      + "&callback=" + encodeURIComponent(cbName);
    s.src = url;
    s.onerror = () =>{
      loadingPanel.style.display = "none";
      errorPanel.style.display   = "block";
      errorText.textContent = "Nepodařilo se načíst test (chyba připojení).";
    };
    document.body.appendChild(s);
  }

  function initTest(t, requestedId){
    const qs = Array.isArray(t.questions) ? t.questions.slice() : [];
    if (!qs.length) {
      loadingPanel.style.display = "none";
      errorPanel.style.display   = "block";
      errorText.textContent = "Test neobsahuje žádné otázky.";
      return;
    }

    const shuffleQuestions = !!t.shuffleQuestions;
    const shuffleAnswers   = !!t.shuffleAnswers;

    let questions = qs.map(q => ({
      id: q.id || ("Q" + Math.random().toString(36).slice(2)),
      text: q.text || "",
      points: Number(q.points) > 0 ? Number(q.points) : 1,
      answers: (q.answers || []).map(a => ({
        text: a.text || "",
        isCorrect: !!a.isCorrect
      }))
    })).filter(q => q.text && q.answers.length >= 2);

    if (shuffleQuestions) {
      questions = shuffle(questions);
    }
    if (shuffleAnswers) {
      questions.forEach(q => {
        q.answers = shuffle(q.answers);
      });
    }

    const maxPoints = questions.reduce((sum,q)=>sum + (Number(q.points)||1),0);

    // uložit konfiguraci pro zbytek kódu
    testConfig = {
      testId: t.testId || requestedId,
      questions,
      maxPoints,

      // nový model časování
      timeLimitSec: t.timeLimitSec || null,

      // podpora starého i nového payloadu
      startWindowFrom: t.startWindowFrom || t.startAt || null,
      startWindowTo:   t.startWindowTo   || t.endAt   || null
    };

    // přepnout UI
    loadingPanel.style.display = "none";
    errorPanel.style.display   = "none";
    studentPanel.style.display = "block";

    let parts = [
      `Kód testu: ${testConfig.testId}.`,
      `Otázek: ${questions.length}.`,
      `Maximální počet bodů: ${maxPoints}.`
    ];

    if (testConfig.timeLimitSec) {
      parts.push(`Čas na vyplnění po spuštění: ${Math.round(testConfig.timeLimitSec / 60)} minut.`);
    } else {
      parts.push(`Bez pevného časového limitu.`);
    }

    if (testConfig.startWindowFrom || testConfig.startWindowTo) {
      const fromTxt = testConfig.startWindowFrom ? formatDateTime(testConfig.startWindowFrom) : "nyní";
      const toTxt   = testConfig.startWindowTo   ? formatDateTime(testConfig.startWindowTo)   : "kdykoliv";
      parts.push(`Test je možné ZAČÍT mezi ${fromTxt} a ${toTxt}.`);
    }

    testInfo.textContent = parts.join(" ");

    if (pageTitleEl) pageTitleEl.textContent = "Online test – " + testConfig.testId;
    document.title = "Online test – " + testConfig.testId;
  }

  // =====================================================================
  // Start testu
  // =====================================================================
  btnStartTest.addEventListener('click', ()=>{
    if(!testConfig){
      startError.textContent = "Test nebyl správně načten. Zkus obnovit stránku.";
      return;
    }

    const name = document.getElementById('student-name').value.trim();
    if(!name){
      startError.textContent = "Zadej prosím své jméno nebo kód.";
      return;
    }

    // kontrola časového okna pro ZAČÁTEK testu
    const now = new Date();
    if (testConfig.startWindowFrom) {
      const from = new Date(testConfig.startWindowFrom);
      if (now < from) {
        startError.textContent = "Test ještě není možné začít psát.";
        return;
      }
    }
    if (testConfig.startWindowTo) {
      const to = new Date(testConfig.startWindowTo);
      if (now > to) {
        startError.textContent = "Čas pro zahájení testu už vypršel.";
        return;
      }
    }

    startError.textContent = "";

    testState.studentName = name;
    testState.startedAt = now.toISOString();
    testState.finished = false;
    testState.currentIndex = 0;
    testState.answers = {};
    testState.finishedAt = null;
    if(testState.timerInterval){
      clearInterval(testState.timerInterval);
      testState.timerInterval = null;
    }

    // přepsat nadpis na jméno žáka
    if (pageTitleEl) pageTitleEl.textContent = name;
    const tt = document.getElementById('test-title');
    if (tt) tt.textContent = name;
    document.title = name + " – online test";

    // pustit fake video proti zamykání
    if (keepAwakeVideo) {
      keepAwakeVideo.play().catch(err=>{
        console.log("Autoplay videa zablokován:", err);
      });
    }

    // časový limit po spuštění
    if(testConfig.timeLimitSec){
      testState.remainingSeconds = testConfig.timeLimitSec;
      timerEl.style.display = "inline-flex";
      updateTimerDisplay();
      testState.timerInterval = setInterval(()=>{
        testState.remainingSeconds--;
        if(testState.remainingSeconds <= 0){
          testState.remainingSeconds = 0;
          updateTimerDisplay(true);
          clearInterval(testState.timerInterval);
          testState.timerInterval = null;
          if(!testState.finished){
            finishTest("timeup");
          }
        }else{
          updateTimerDisplay();
        }
      },1000);
    }else{
      timerEl.style.display = "none";
    }

    document.getElementById('test-subtitle').textContent =
      testConfig.timeLimitSec
        ? `Časový limit: ${Math.round(testConfig.timeLimitSec/60)} minut`
        : `Bez časového omezení.`;

    studentStartDiv.style.display = "none";
    studentTestDiv.style.display  = "block";
    studentResultDiv.style.display= "none";

    buildQuestionNav();
    renderCurrentQuestion();
    testHint.textContent = "Zelená čísla nahoře označují otázky, u kterých už máš nějakou odpověď.";
  });

  function updateTimerDisplay(isOver){
    const s = testState.remainingSeconds;
    const m = Math.floor(s/60);
    const sec = s % 60;
    timerEl.textContent = `${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
    timerEl.classList.remove("expiring","over");
    if(isOver){
      timerEl.classList.add("over");
    }else if(s <= 60){
      timerEl.classList.add("expiring");
    }
  }

  // =====================================================================
  // Navigace mezi otázkami
  // =====================================================================
  function buildQuestionNav(){
    questionNav.innerHTML = "";
    const qs = testConfig.questions;
    for(let i=0;i<qs.length;i++){
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.dataset.index = i;
      badge.textContent = (i+1);
      badge.addEventListener('click', ()=>{
        saveCurrentAnswers();
        testState.currentIndex = i;
        renderCurrentQuestion();
      });
      questionNav.appendChild(badge);
    }
    refreshQuestionNavStyles();
  }

  function refreshQuestionNavStyles(){
    const qs = testConfig.questions;
    const badges = questionNav.querySelectorAll(".badge");
    badges.forEach((b,idx)=>{
      b.classList.remove("current","answered");
      if(idx === testState.currentIndex){
        b.classList.add("current");
      }
      const q = qs[idx];
      if(q && Array.isArray(testState.answers[q.id]) && testState.answers[q.id].length>0){
        b.classList.add("answered");
      }
    });
  }

  function renderCurrentQuestion(){
    const qs = testConfig.questions;
    const index = testState.currentIndex;
    const q = qs[index];
    if(!q) return;

    // otázka – jako HTML kvůli MathJaxu
    questionText.innerHTML = `${index+1}. ${q.text}`;

    // odpovědi – také jako HTML
    answersEl.innerHTML = "";
    const selected = testState.answers[q.id] || [];
    q.answers.forEach((a,idx)=>{
      const label = document.createElement("label");
      const input = document.createElement("input");
      input.type = "checkbox";
      input.value = idx;
      input.checked = selected.includes(idx);
      input.addEventListener('change', ()=>{
        saveCurrentAnswers();
        refreshQuestionNavStyles();
      });
      const span = document.createElement("span");
      span.innerHTML = a.text;
      label.appendChild(input);
      label.appendChild(span);
      answersEl.appendChild(label);
    });

    btnPrev.disabled = (index === 0);
    btnNext.disabled = (index === qs.length - 1);   // na poslední otázce "Další" nefunguje
    btnNext.textContent = "Další otázka";

    // tlačítko Ukončit test jen u poslední otázky
    if (index === qs.length - 1) {
      btnFinish.style.display = "inline-block";
    } else {
      btnFinish.style.display = "none";
    }

    refreshQuestionNavStyles();


    // MathJax přetypování aktuální otázky a odpovědí
    if (window.MathJax && MathJax.typesetPromise) {
      MathJax.typesetPromise([questionText, answersEl]).catch(err => {
        console.error("MathJax error:", err);
      });
    }
  }

  function saveCurrentAnswers(){
    const qs = testConfig.questions;
    const index = testState.currentIndex;
    const q = qs[index];
    if(!q) return;
    const checkboxes = answersEl.querySelectorAll("input[type='checkbox']");
    const selected = [];
    checkboxes.forEach((cb,idx)=>{
      if(cb.checked) selected.push(idx);
    });
    testState.answers[q.id] = selected;
  }

  btnPrev.addEventListener('click', ()=>{
    saveCurrentAnswers();
    if(testState.currentIndex > 0){
      testState.currentIndex--;
      renderCurrentQuestion();
    }
  });

  btnNext.addEventListener('click', ()=>{
    saveCurrentAnswers();
    const qs = testConfig.questions;
    if (testState.currentIndex < qs.length - 1) {
      testState.currentIndex++;
      renderCurrentQuestion();
    }
    // na poslední otázce je tlačítko Další zakázané (disabled),
    // takže se sem už nedostaneme
  });


  btnFinish.addEventListener('click', ()=>{
    saveCurrentAnswers();
    if(confirm("Opravdu chceš test ukončit?")){
      finishTest("manual");
    }
  });

  // =====================================================================
  // Vyhodnocení testu
  // =====================================================================
  function finishTest(reason){
    if(testState.finished) return;
    testState.finished = true;
    testState.finishedAt = new Date().toISOString();
    if(testState.timerInterval){
      clearInterval(testState.timerInterval);
      testState.timerInterval = null;
    }

    // zastavit fake video
    if (keepAwakeVideo) {
      keepAwakeVideo.pause();
      keepAwakeVideo.currentTime = 0;
    }

    const qs = testConfig.questions;
    let totalPoints = 0;
    const maxPoints = testConfig.maxPoints;
    const details = [];

    qs.forEach((q,idx)=>{
      const answersTexts = q.answers.map(a=>a.text);
      const correctIdxs  = q.answers
        .map((a,i)=>a.isCorrect ? i : -1)
        .filter(i=>i>=0);
      const selectedIdxs = Array.isArray(testState.answers[q.id])
        ? testState.answers[q.id].slice()
        : [];

      // porovnání množin (nezáleží na pořadí)
      const sortNum = arr => arr.slice().sort((a,b)=>a-b);
      const isCorrect =
        sortNum(correctIdxs).join(",") === sortNum(selectedIdxs).join(",");

      const qPoints = Number(q.points) > 0 ? Number(q.points) : 1;
      if(isCorrect) totalPoints += qPoints;

      const correctTexts  = correctIdxs.map(i=>answersTexts[i]);
      const selectedTexts = selectedIdxs.map(i=>answersTexts[i]);

      details.push({
        questionIndex: idx+1,
        questionText: q.text,
        isCorrect: isCorrect,
        correctAnswersTexts: correctTexts,
        selectedAnswersTexts: selectedTexts
      });
    });

    const result = {
      testId: testConfig.testId,
      studentName: testState.studentName,
      startedAt: testState.startedAt,
      finishedAt: testState.finishedAt,
      reason: reason || "",
      totalPoints,
      maxPoints,
      answers: details
    };

    studentTestDiv.style.display  = "none";
    studentResultDiv.style.display= "block";
    resultSummary.textContent = `Získal/a jsi ${totalPoints} z ${maxPoints} bodů.`;

    // pokud chceš někdy debugovat:
    // resultJson.style.display = "block";
    // resultJson.textContent   = JSON.stringify(result, null, 2);

    sendEvent("finish", result);
  }

  // =====================================================================
  // Odesílání událostí na Apps Script
  // =====================================================================
  function sendEvent(eventType, payload){
    if(!API_URL) return;
    const body = Object.assign({}, payload, {
      eventType,
      testId: testConfig ? testConfig.testId : "",
      studentName: testState.studentName || ""
    });
    try{
      fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(body)
      }).catch(err=>{
        console.error("Chyba při odesílání na server:", err);
      });
    }catch(e){
      console.error("Výjimka při odesílání na server:", e);
    }
  }

  // odchod z tab / minimalizace – test se ukončí
  document.addEventListener('visibilitychange', ()=>{
    if(testState.startedAt && !testState.finished && document.hidden){
      // volitelně zalogujeme, že odešel
      sendEvent("visibilityHidden", { time: new Date().toISOString() });
      // a hned ukončíme test
      finishTest("switchTab");
    }
  });

  // =====================================================================
  // Pomocné funkce
  // =====================================================================
  function shuffle(arr){
    const a = (arr || []).slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function formatDateTime(iso){
    const d = new Date(iso);
    if(isNaN(d.getTime())) return iso;
    const pad = n => String(n).padStart(2,"0");
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function formatPoints(p){
    if (p === 1) return "1 bod";
    if (p >= 2 && p <= 4) return `${p} body`;
    return `${p} bodů`;
  }
</script>
</body>
</html>
