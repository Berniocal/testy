<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Online test z Excelu</title>
  <meta name="theme-color" content="#0b1323">
  <style>
    :root{
      --bg:#0b1323; --bg2:#0f1722; --panel:#101826;
      --text:#e6eef8; --muted:#9fb0c7; --accent:#60a5fa;
      --ok:#22c55e; --warn:#f97316; --err:#ef4444;
      --r:14px; --gap:12px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0;
      min-height:100%;
      background:linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{max-width:min(1100px,96vw);margin:20px auto;padding:10px}
    h1,h2,h3{margin:0 0 10px}
    .panel{
      background:var(--panel);
      border-radius:var(--r);
      padding:16px;
      box-shadow:0 14px 40px rgba(0,0,0,.4);
      margin-bottom:16px;
    }
    label{display:block;margin:6px 0;}
    input[type="number"], input[type="text"], input[type="datetime-local"]{
      width:100%;
      max-width:260px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #1f2937;
      background:#0b1220;
      color:var(--text);
    }
    input[type="checkbox"]{margin-right:6px}
    button{
      border:0;
      padding:8px 14px;
      border-radius:999px;
      background:var(--accent);
      color:#0b1020;
      font-weight:600;
      cursor:pointer;
      margin:4px 4px 0 0;
    }
    button[disabled]{opacity:.55;cursor:not-allowed}
    .muted{color:var(--muted);font-size:.9rem}
    .row{display:flex;flex-wrap:wrap;gap:var(--gap);}
    .row > div{flex:1 1 260px}
    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      min-width:26px;height:26px;
      padding:0 8px;
      border-radius:999px;
      font-size:.9rem;
      border:1px solid #1f2937;
      background:#020617;
      margin:2px;
      cursor:pointer;
      user-select:none;
    }
    .badge.answered{background:#022c22;border-color:#16a34a;color:#bbf7d0}
    .badge.current{outline:2px solid var(--accent);}
    .badge:hover{background:#02091a}
    .q-text{font-size:1.05rem;margin-bottom:8px}
    .answers label{
      display:flex;align-items:flex-start;
      gap:8px;
      padding:6px 8px;
      border-radius:10px;
      background:#020617;
      margin-bottom:4px;
      cursor:pointer;
    }
    .answers input{margin-top:3px}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:8px;
      flex-wrap:wrap;gap:8px;
    }
    .timer{
      padding:4px 10px;
      border-radius:999px;
      background:#020617;
      border:1px solid #1f2937;
      font-weight:600;
    }
    .timer.expiring{background:#3b0764;border-color:#a855f7}
    .timer.over{background:#3b0a0a;border-color:#b91c1c}
    .nav-row{
      display:flex;flex-wrap:wrap;gap:4px;
      margin-bottom:8px;
    }
    .btn-row{
      display:flex;justify-content:space-between;
      margin-top:12px;gap:8px;
    }
    .btn-secondary{
      background:#020617;color:var(--text);
      border:1px solid #1f2937;
    }
    pre{
      background:#020617;
      padding:8px 10px;
      border-radius:8px;
      font-size:.8rem;
      overflow:auto;
      max-height:240px;
    }
    @media (max-width:600px){
      .btn-row{flex-direction:column;}
      .btn-row button{width:100%}
    }
  </style>
  <!-- SheetJS pro čtení Excelu (.xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Online test z Excelu</h1>

  <!-- Panel učitele -->
  <div class="panel" id="teacher-panel">
    <h2>1) Nastavení testu (učitel)</h2>
    <div class="row">
      <div>
        <label>
          Soubor Excel (.xlsx) s otázkami:
          <input type="file" id="file-input" accept=".xlsx">
        </label>
        <div class="muted">
          Sloupec A = otázka, B–G = odpovědi. Správné odpovědi označ hvězdičkou <code>*</code> na konci textu.
        </div>
        <label style="margin-top:8px;">
          ID testu (krátký kód, např. <i>9A-elektro-1</i>):
          <input type="text" id="test-id" placeholder="např. 9A-elektro-1">
        </label>
        <div class="muted">Tento kód se uloží k výsledkům v Google tabulce.</div>
      </div>
      <div>
        <strong>Volby:</strong>
        <label><input type="checkbox" id="shuffle-questions" checked> Míchat pořadí otázek</label>
        <label><input type="checkbox" id="shuffle-answers" checked> Míchat pořadí odpovědí</label>
      </div>
      <div>
        <strong>Časování:</strong>
        <label>
          <input type="radio" name="time-mode" value="limit" id="mode-limit" checked>
          Časový limit na test (minuty):
        </label>
        <input type="number" id="time-limit" min="1" max="300" value="20">

        <label style="margin-top:8px;">
          <input type="radio" name="time-mode" value="window" id="mode-window">
          Časové okno (od – do):
        </label>
        <label>Začátek:
          <input type="datetime-local" id="start-at">
        </label>
        <label>Konec:
          <input type="datetime-local" id="end-at">
        </label>
        <div class="muted">
          V tomto prototypu se okno kontroluje podle času zařízení žáka.
        </div>
      </div>
    </div>
    <button id="btn-preview" disabled>Zobrazit náhled otázek</button>
    <button id="btn-start-local" disabled>Spustit test (lokálně v tomto prohlížeči)</button>
    <div id="teacher-info" class="muted" style="margin-top:8px;"></div>
    <div id="preview" style="margin-top:10px;"></div>
  </div>

  <!-- Panel žáka -->
  <div class="panel" id="student-panel" style="display:none;">
    <div id="student-start">
      <h2>Test – přihlášení žáka</h2>
      <label>
        Jméno nebo kód žáka:
        <input type="text" id="student-name" placeholder="Např. Novák Jan nebo 2.A-05">
      </label>
      <div class="muted">Pouze pro identifikaci výsledků (stejné jako u papírového testu).</div>
      <button id="btn-start-test">Začít test</button>
      <div id="start-error" class="muted" style="color:var(--err);margin-top:6px;"></div>
    </div>

    <div id="student-test" style="display:none;">
      <div class="topbar">
        <div>
          <strong id="test-title">Test</strong><br>
          <span class="muted" id="test-subtitle"></span>
        </div>
        <div id="timer" class="timer" style="display:none;">--:--</div>
      </div>

      <div class="nav-row" id="question-nav"></div>

      <div id="question-area">
        <div class="q-text" id="q-text"></div>
        <div class="answers" id="answers"></div>
      </div>

      <div class="btn-row">
        <button class="btn-secondary" id="btn-prev" disabled>Předchozí otázka</button>
        <button id="btn-next">Další otázka</button>
      </div>
      <div class="muted" style="margin-top:6px;" id="test-hint"></div>
    </div>

    <div id="student-result" style="display:none;margin-top:10px;">
      <h3>Výsledek testu</h3>
      <div id="result-summary"></div>
      <div class="muted" style="margin-top:6px;">
        Níže je technický výpis dat (tohle půjde do Google Sheets přes Apps Script):
      </div>
      <pre id="result-json"></pre>
    </div>
  </div>
</div>

<script>
  // >>> SEM VLOŽ SVOU URL WEBAPP Z APPS SCRIPTU <<<
const API_URL = "https://script.google.com/macros/s/AKfycby_nyIz2pYtHD3h00eOW9cxi25DuEEe4jAN3a2MHj-2Y-fmGoffC_SE_zYj4VDNUC-x/exec";


  // --- Globální stav ---
  let loadedQuestions = [];   // z Excelu
  let testConfig = null;      // konfigurace testu
  let testState = {
    studentName: "",
    startedAt: null,
    finishedAt: null,
    currentIndex: 0,
    answers: {}, // { questionId: [indexy odpovědí] }
    timerMode: null, // "limit" | "window" | null
    remainingSeconds: 0,
    timerInterval: null,
    finished: false
  };

  const fileInput = document.getElementById('file-input');
  const btnPreview = document.getElementById('btn-preview');
  const btnStartLocal = document.getElementById('btn-start-local');
  const teacherInfo = document.getElementById('teacher-info');
  const previewDiv = document.getElementById('preview');

  const studentPanel = document.getElementById('student-panel');
  const teacherPanel = document.getElementById('teacher-panel');

  // --- 1) Načtení Excelu ---
  fileInput.addEventListener('change', handleFileSelect);

  function handleFileSelect(evt){
    const file = evt.target.files[0];
    loadedQuestions = [];
    btnPreview.disabled = true;
    btnStartLocal.disabled = true;
    previewDiv.innerHTML = "";
    teacherInfo.textContent = "";

    if(!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      try{
        const data = e.target.result;
        const workbook = XLSX.read(data, {type:'array'});
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1}); // 2D pole

        for(let i=1;i<rows.length;i++){
          const row = rows[i];
          if(!row || !row[0]) continue; // prázdná otázka
          const qText = String(row[0]).trim();
          const answers = [];
          for(let col=1; col<=6; col++){
            const cell = row[col];
            if(cell == null || cell === "") continue;
            let txt = String(cell).trim();
            let isCorrect = false;
            if(/\*+$/.test(txt)){
              isCorrect = true;
              txt = txt.replace(/\*+$/,"").trim();
            }
            answers.push({text: txt, isCorrect:isCorrect});
          }
          if(answers.length >= 2){
            const id = "Q" + i;
            loadedQuestions.push({id, text:qText, answers});
          }
        }

        if(loadedQuestions.length === 0){
          teacherInfo.textContent = "V souboru se nenašly žádné platné otázky.";
          return;
        }
        teacherInfo.textContent = `Načteno otázek: ${loadedQuestions.length}.`;
        btnPreview.disabled = false;
        btnStartLocal.disabled = false;
      }catch(err){
        console.error(err);
        teacherInfo.textContent = "Chyba při čtení Excelu. Zkontroluj formát.";
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // --- 2) Náhled otázek pro učitele ---
  btnPreview.addEventListener('click', ()=>{
    if(!loadedQuestions.length) return;
    const maxPreview = Math.min(5, loadedQuestions.length);
    let html = `<h3>Náhled prvních ${maxPreview} otázek</h3>`;
    html += "<ol>";
    for(let i=0;i<maxPreview;i++){
      const q = loadedQuestions[i];
      html += `<li>${escapeHtml(q.text)}<ul>`;
      q.answers.forEach(a=>{
        html += `<li>${escapeHtml(a.text)} ${a.isCorrect ? "<strong>(správně)</strong>" : ""}</li>`;
      });
      html += "</ul></li>";
    }
    html += "</ol>";
    previewDiv.innerHTML = html;
  });

  // --- 3) Spuštění testu (lokálně) ---
  btnStartLocal.addEventListener('click', ()=>{
    if(!loadedQuestions.length) return;

    const shuffleQuestions = document.getElementById('shuffle-questions').checked;
    const shuffleAnswers = document.getElementById('shuffle-answers').checked;
    const modeLimit = document.getElementById('mode-limit').checked;
    const modeWindow = document.getElementById('mode-window').checked;
    const timeLimitMin = parseInt(document.getElementById('time-limit').value,10) || 0;
    const startAtStr = document.getElementById('start-at').value;
    const endAtStr = document.getElementById('end-at').value;
    const testIdInput = document.getElementById('test-id');
    const testId = testIdInput && testIdInput.value.trim()
      ? testIdInput.value.trim()
      : "TEST-" + Date.now();

    let questions = JSON.parse(JSON.stringify(loadedQuestions)); // deep copy

    if(shuffleQuestions){
      questions = shuffle(questions);
    }
    if(shuffleAnswers){
      questions.forEach(q => {
        q.answers = shuffle(q.answers);
      });
    }

    testConfig = {
      testId,
      questions,
      shuffleQuestions,
      shuffleAnswers,
      timeMode: modeLimit ? "limit" : (modeWindow ? "window" : null),
      timeLimitSec: modeLimit && timeLimitMin>0 ? timeLimitMin*60 : null,
      startAt: modeWindow && startAtStr ? new Date(startAtStr).toISOString() : null,
      endAt: modeWindow && endAtStr ? new Date(endAtStr).toISOString() : null
    };

    // Přepnout do panelu žáka
    teacherPanel.style.display = "none";
    studentPanel.style.display = "block";

    const subtitle = document.getElementById('test-subtitle');
    if(testConfig.timeMode === "limit" && testConfig.timeLimitSec){
      subtitle.textContent = `Časový limit: ${Math.round(testConfig.timeLimitSec/60)} minut`;
    }else if(testConfig.timeMode === "window" && testConfig.startAt && testConfig.endAt){
      subtitle.textContent = `Test lze psát mezi ${formatDateTime(testConfig.startAt)} a ${formatDateTime(testConfig.endAt)} (čas zařízení žáka).`;
    }else{
      subtitle.textContent = `Bez časového omezení (v tomto prototypu).`;
    }
  });

  // --- 4) Žák – start testu ---
  const btnStartTest = document.getElementById('btn-start-test');
  const startError = document.getElementById('start-error');
  const studentStartDiv = document.getElementById('student-start');
  const studentTestDiv = document.getElementById('student-test');
  const studentResultDiv = document.getElementById('student-result');
  const timerEl = document.getElementById('timer');
  const questionNav = document.getElementById('question-nav');
  const qTextEl = document.getElementById('q-text');
  const answersEl = document.getElementById('answers');
  const btnPrev = document.getElementById('btn-prev');
  const btnNext = document.getElementById('btn-next');
  const testHint = document.getElementById('test-hint');
  const resultSummary = document.getElementById('result-summary');
  const resultJson = document.getElementById('result-json');

  btnStartTest.addEventListener('click', ()=>{
    const name = document.getElementById('student-name').value.trim();
    if(!name){
      startError.textContent = "Zadej prosím své jméno nebo kód.";
      return;
    }
    startError.textContent = "";
    testState.studentName = name;
    testState.startedAt = new Date().toISOString();
    testState.finished = false;
    testState.currentIndex = 0;
    testState.answers = {};
    testState.finishedAt = null;
    if(testState.timerInterval){
      clearInterval(testState.timerInterval);
      testState.timerInterval = null;
    }

    // Časové okno
    if(testConfig.timeMode === "window" && testConfig.startAt && testConfig.endAt){
      const now = new Date();
      const startAt = new Date(testConfig.startAt);
      const endAt = new Date(testConfig.endAt);
      if(now < startAt){
        alert("Test ještě nezačal. Počkej prosím do času začátku.");
        return;
      }
      if(now > endAt){
        alert("Test už byl ukončen.");
        return;
      }
    }

    // Timer
    if(testConfig.timeMode === "limit" && testConfig.timeLimitSec){
      testState.timerMode = "limit";
      testState.remainingSeconds = testConfig.timeLimitSec;
      timerEl.style.display = "inline-flex";
      updateTimerDisplay();
      testState.timerInterval = setInterval(()=>{
        testState.remainingSeconds--;
        if(testState.remainingSeconds <= 0){
          testState.remainingSeconds = 0;
          updateTimerDisplay(true);
          clearInterval(testState.timerInterval);
          testState.timerInterval = null;
          if(!testState.finished){
            finishTest("timeup");
          }
        }else{
          updateTimerDisplay();
        }
      },1000);
    }else{
      timerEl.style.display = "none";
      testState.timerMode = null;
    }

    studentStartDiv.style.display = "none";
    studentTestDiv.style.display = "block";
    studentResultDiv.style.display = "none";

    buildQuestionNav();
    renderCurrentQuestion();
    testHint.textContent = "Zelená čísla nahoře označují otázky, u kterých už máš nějakou odpověď.";
  });

  function updateTimerDisplay(isOver){
    const s = testState.remainingSeconds;
    const m = Math.floor(s/60);
    const sec = s % 60;
    timerEl.textContent = `${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}`;
    timerEl.classList.remove("expiring","over");
    if(isOver){
      timerEl.classList.add("over");
    }else if(s <= 60){
      timerEl.classList.add("expiring");
    }
  }

  // --- 5) Navigace mezi otázkami ---
  function buildQuestionNav(){
    questionNav.innerHTML = "";
    const qs = testConfig.questions;
    for(let i=0;i<qs.length;i++){
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.dataset.index = i;
      badge.textContent = (i+1);
      badge.addEventListener('click', ()=>{
        if(testState.finished) return;
        saveCurrentAnswers();
        testState.currentIndex = i;
        renderCurrentQuestion();
      });
      questionNav.appendChild(badge);
    }
    refreshQuestionNavStyles();
  }

  function refreshQuestionNavStyles(){
    const badges = questionNav.querySelectorAll(".badge");
    const qs = testConfig.questions;
    badges.forEach(b=>{
      b.classList.remove("answered","current");
      const idx = parseInt(b.dataset.index,10);
      const q = qs[idx];
      const ans = testState.answers[q.id];
      if(ans && ans.length>0){
        b.classList.add("answered");
      }
      if(idx === testState.currentIndex){
        b.classList.add("current");
      }
    });
  }

  function renderCurrentQuestion(){
    const qs = testConfig.questions;
    const index = testState.currentIndex;
    const q = qs[index];
    if(!q) return;

    qTextEl.textContent = `Otázka ${index+1}/${qs.length}: ${q.text}`;
    answersEl.innerHTML = "";

    const selected = testState.answers[q.id] || [];

    q.answers.forEach((a,idx)=>{
      const id = `ans-${index}-${idx}`;
      const label = document.createElement("label");
      const input = document.createElement("input");
      input.type = "checkbox"; // více správných odpovědí
      input.id = id;
      input.checked = selected.includes(idx);
      input.addEventListener('change', ()=>{
        saveCurrentAnswers();
        refreshQuestionNavStyles();
      });
      const span = document.createElement("span");
      span.textContent = a.text;
      label.appendChild(input);
      label.appendChild(span);
      answersEl.appendChild(label);
    });

    btnPrev.disabled = (index === 0);
    if(index === qs.length-1){
      btnNext.textContent = "Ukončit test";
    }else{
      btnNext.textContent = "Další otázka";
    }
    refreshQuestionNavStyles();
  }

  function saveCurrentAnswers(){
    const qs = testConfig.questions;
    const index = testState.currentIndex;
    const q = qs[index];
    if(!q) return;
    const checkboxes = answersEl.querySelectorAll("input[type='checkbox']");
    const selected = [];
    checkboxes.forEach((cb,idx)=>{
      if(cb.checked) selected.push(idx);
    });
    testState.answers[q.id] = selected;
  }

  btnPrev.addEventListener('click', ()=>{
    if(testState.currentIndex > 0){
      saveCurrentAnswers();
      testState.currentIndex--;
      renderCurrentQuestion();
    }
  });

  btnNext.addEventListener('click', ()=>{
    const qs = testConfig.questions;
    const index = testState.currentIndex;
    if(index < qs.length-1){
      saveCurrentAnswers();
      testState.currentIndex++;
      renderCurrentQuestion();
    }else{
      const ok = confirm("Opravdu chceš test ukončit? Po odeslání už nebude možné odpovědi měnit.");
      if(ok){
        saveCurrentAnswers();
        finishTest("manual");
      }
    }
  });

  // --- 6) Vyhodnocení testu ---
  function finishTest(reason){
    if(testState.finished) return;
    testState.finished = true;
    testState.finishedAt = new Date().toISOString();
    if(testState.timerInterval){
      clearInterval(testState.timerInterval);
      testState.timerInterval = null;
    }

    const qs = testConfig.questions;
    let points = 0;
    const details = [];

    qs.forEach((q,idx)=>{
      const correctIdxs = q.answers
        .map((a,i)=>a.isCorrect ? i : -1)
        .filter(i=>i>=0);
      const selectedIdxs = testState.answers[q.id] || [];
      const isCorrect =
        correctIdxs.length === selectedIdxs.length &&
        correctIdxs.every(i=>selectedIdxs.includes(i));
      if(isCorrect) points++;

      details.push({
        questionIndex: idx+1,
        questionId: q.id,
        questionText: q.text,
        correctAnswerIndices: correctIdxs,
        selectedAnswerIndices: selectedIdxs,
        isCorrect
      });
    });

    const result = {
      studentName: testState.studentName,
      testId: testConfig.testId,
      startedAt: testState.startedAt,
      finishedAt: testState.finishedAt,
      reason,
      totalPoints: points,
      maxPoints: qs.length,
      answers: details
    };

    studentTestDiv.style.display = "none";
    studentResultDiv.style.display = "block";
    resultSummary.textContent = `Získal/a jsi ${points} z ${qs.length} bodů.`;
    resultJson.textContent = JSON.stringify(result, null, 2);

    console.log("Výsledek testu:", result);

    // odeslání na server (Apps Script)
    sendEvent("finish", result);
  }

  // --- 7) Detekce opuštění testu (tab/minimalizace) ---
  document.addEventListener('visibilitychange', ()=>{
    if(testState.startedAt && !testState.finished && document.hidden){
      console.log("Student pravděpodobně opustil okno (visibilitychange hidden).");
      sendEvent("leave", { reason:"visibility-hidden", time:new Date().toISOString() });
      alert("Test byl ukončen, protože jsi opustil okno testu.");
      finishTest("left-window");
    }
  });

  window.addEventListener('blur', ()=>{
    if(testState.startedAt && !testState.finished){
      console.log("Student pravděpodobně přešel do jiného okna (blur).");
      sendEvent("leave", { reason:"blur", time:new Date().toISOString() });
      alert("Test byl ukončen, protože jsi přešel do jiného okna.");
      finishTest("left-window");
    }
  });

function sendEvent(eventType, payload){
  if(!API_URL) {
    console.warn("API_URL není nastaveno, data se neposílají.");
    return;
  }

  const body = Object.assign({}, payload, {
    eventType: eventType,
    testId: testConfig ? testConfig.testId : "",
    studentName: testState.studentName || ""
  });

  try {
    // fire-and-forget, CORS se nebude řešit
    fetch(API_URL, {
      method: "POST",
      mode: "no-cors",
      body: JSON.stringify(body)
    }).catch(err => {
      console.error("Chyba při odesílání na server:", err);
    });
  } catch (e) {
    console.error(e);
  }
}


  // --- Pomocné funkce ---
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }
  function escapeHtml(str){
    return String(str)
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;");
  }
  function formatDateTime(iso){
    const d = new Date(iso);
    if(isNaN(d.getTime())) return iso;
    const pad = n => String(n).padStart(2,"0");
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
</script>
</body>
</html>
